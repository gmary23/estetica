# Etapa 1: Base - Com as depend√™ncias j√° instaladas
FROM node:20-alpine3.19 AS base
WORKDIR /app

# Instalar depend√™ncias necess√°rias para o SWC no Alpine
RUN apk add --no-cache libc6-compat bash openssh-client docker-cli

# Copiar arquivos essenciais e instalar depend√™ncias
COPY package.json package-lock.json ./

# Define um argumento que pode ser passado durante o build
ARG NODE_ENV=development 
# Instala TODAS as depend√™ncias (incluindo devDependencies) se n√£o for produ√ß√£o
RUN if [ "$NODE_ENV" = "production" ]; then npm install --omit=dev; else npm install; fi


# Etapa 2: Build (para produ√ß√£o e homologa√ß√£o)
# Esta etapa agora usa a base com as depend√™ncias j√° instaladas
FROM base AS build
WORKDIR /app
COPY . .
RUN npm run build 


# Etapa 3: Desenvolvimento - A etapa que nosso Dev Container vai usar
FROM base AS development
# RUN adduser --disabled-password --gecos '' node

WORKDIR /app

# üëá A MUDAN√áA MAIS IMPORTANTE EST√Å AQUI üëá
# Copia o resto do c√≥digo-fonte, j√° definindo o 'node' como dono dos arquivos.
# Isso evita todos os nossos problemas de permiss√£o.
# COPY --chown=node:node . .
RUN chown -R node:node /app

COPY . .

# Define o usu√°rio padr√£o para este est√°gio.
# Isso significa que o CMD e qualquer comando futuro ser√° executado como 'node'.
USER node

ENV NODE_ENV=development
EXPOSE 3000
CMD ["tail", "-f", "/dev/null"]


# Etapa 4: Produ√ß√£o (ser√° usado com NGINX)
FROM base AS production
WORKDIR /app
USER node

# Copiar apenas o build e as depend√™ncias de produ√ß√£o
COPY --from=build /app/.next ./.next
# A node_modules j√° foi copiada na etapa 'base', n√£o precisamos copiar de novo se a base for a mesma.
COPY --from=build /app/package.json ./package.json

CMD ["npm", "run", "start"]```