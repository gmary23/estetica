# Etapa 1: Base - Com as dependÃªncias jÃ¡ instaladas
FROM node:20-alpine3.19 AS base
WORKDIR /app

# Instalar dependÃªncias necessÃ¡rias para o SWC no Alpine
RUN apk add --no-cache libc6-compat bash openssh-client docker-cli

# Copiar arquivos essenciais e instalar dependÃªncias
COPY package.json package-lock.json ./

# Define um argumento que pode ser passado durante o build
ARG NODE_ENV=development 
# Instala TODAS as dependÃªncias (incluindo devDependencies) se nÃ£o for produÃ§Ã£o
RUN if [ "$NODE_ENV" = "production" ]; then npm install --omit=dev; else npm install; fi


# Etapa 2: Build (para produÃ§Ã£o e homologaÃ§Ã£o)
# Esta etapa agora usa a base com as dependÃªncias jÃ¡ instaladas
FROM base AS build
WORKDIR /app
COPY . .
RUN npm run build 


# Etapa 3: Desenvolvimento - A etapa que nosso Dev Container vai usar
FROM base AS development
WORKDIR /app

# ğŸ‘‡ A MUDANÃ‡A MAIS IMPORTANTE ESTÃ AQUI ğŸ‘‡
# Copia o resto do cÃ³digo-fonte, jÃ¡ definindo o 'node' como dono dos arquivos.
# Isso evita todos os nossos problemas de permissÃ£o.
COPY --chown=node:node . .

# Define o usuÃ¡rio padrÃ£o para este estÃ¡gio.
# Isso significa que o CMD e qualquer comando futuro serÃ¡ executado como 'node'.
USER node

ENV NODE_ENV=development
EXPOSE 3000
CMD ["tail", "-f", "/dev/null"]


# Etapa 4: ProduÃ§Ã£o (serÃ¡ usado com NGINX)
FROM base AS production
WORKDIR /app
USER node

# Copiar apenas o build e as dependÃªncias de produÃ§Ã£o
COPY --from=build /app/.next ./.next
# A node_modules jÃ¡ foi copiada na etapa 'base', nÃ£o precisamos copiar de novo se a base for a mesma.
COPY --from=build /app/package.json ./package.json

CMD ["npm", "run", "start"]```